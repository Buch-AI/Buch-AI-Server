name: Deploy Infrastructure and Docker Images

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build-docker:
    environment: google-cloud
    runs-on: ubuntu-latest
    outputs:
      server_image_tag: ${{ env.SERVER_IMAGE_TAG }}
      vidgen_image_tag: ${{ env.VIDGEN_IMAGE_TAG }}
    steps:      
      - name: ⚙️ Set up repository
        uses: actions/checkout@v2
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ⚙️ Authenticate to Google Cloud
        uses: 'google-github-actions/auth@v2'
        with:
          credentials_json: '${{ secrets.GOOGLE_CREDENTIALS }}'

      - name: ⚙️ Set up Cloud SDK
        uses: 'google-github-actions/setup-gcloud@v2'
        with:
          project_id: 'bai-buchai-p'

      - name: 🔐 Configure Docker authentication
        run: |
          gcloud auth configure-docker us-east1-docker.pkg.dev --quiet

      - name: 🏗️ Build Docker images
        env:
          SERVER_IMAGE_TAG: us-east1-docker.pkg.dev/bai-buchai-p/bai-buchai-p-gar-usea1-docker/buch-ai-server:0.1.0
          VIDGEN_IMAGE_TAG: us-east1-docker.pkg.dev/bai-buchai-p/bai-buchai-p-gar-usea1-docker/buch-ai-video-generator:0.1.0
        run: |
          # Build server image
          docker build -t $SERVER_IMAGE_TAG --platform linux/amd64 \
            --build-arg AUTH_JWT_KEY=${{ secrets.AUTH_JWT_KEY }} \
            --build-arg HF_API_KEY=${{ secrets.HF_API_KEY }} \
            .
          
          # Build task image: Video Generator
          docker build -t $VIDGEN_IMAGE_TAG --platform linux/amd64 \
            -f app/tasks/video_generator/Dockerfile \
            .

      - name: 📤 Push Docker images
        env:
          SERVER_IMAGE_TAG: us-east1-docker.pkg.dev/bai-buchai-p/bai-buchai-p-gar-usea1-docker/buch-ai-server:0.1.0
          VIDGEN_IMAGE_TAG: us-east1-docker.pkg.dev/bai-buchai-p/bai-buchai-p-gar-usea1-docker/buch-ai-video-generator:0.1.0
        run: |
          docker push $SERVER_IMAGE_TAG
          docker push $VIDGEN_IMAGE_TAG

  terraform:
    environment: google-cloud
    runs-on: ubuntu-latest
    needs: build-docker
    steps:
      - name: ⚙️ Checkout repository
        uses: actions/checkout@v2

      - name: ⚙️ Authenticate to Google Cloud
        uses: 'google-github-actions/auth@v2'
        with:
          credentials_json: '${{ secrets.GOOGLE_CREDENTIALS }}'

      - name: ⚙️ Set up Cloud SDK
        uses: 'google-github-actions/setup-gcloud@v2'
        with:
          project_id: 'bai-buchai-p'

      - name: ⚙️ Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.7.0"

      - name: ⚙️ Create service account key file
        run: |
          echo '${{ secrets.GOOGLE_CREDENTIALS }}' > service-account.json
          chmod 600 service-account.json

      - name: ⚙️ Generate terraform.tfvars
        run: |
          sed -e "s/{{AUTH_JWT_KEY}}/${{ secrets.AUTH_JWT_KEY }}/g" \
              -e "s/{{HF_API_KEY}}/${{ secrets.HF_API_KEY }}/g" \
              -e "s/{{SERVER_IMAGE_TAG}}/${{ needs.build-docker.outputs.server_image_tag }}/g" \
              -e "s/{{VIDGEN_IMAGE_TAG}}/${{ needs.build-docker.outputs.vidgen_image_tag }}/g" \
              terraform/p.tfvars.template > terraform/terraform.tfvars

      - name: ⚙️ Terraform Init
        working-directory: ./terraform
        run: |
          terraform init \
            -backend-config="bucket=bai-buchai-p-tfstate-usea1" \
            -backend-config="prefix=terraform/state"

      - name: ⚙️ Terraform Validate
        working-directory: ./terraform
        run: terraform validate

      - name: ⚙️ Import Existing Resources
        working-directory: ./terraform
        run: |
          terraform import google_bigquery_dataset.creations projects/bai-buchai-p/datasets/creations || true
          terraform import google_bigquery_dataset.tasks projects/bai-buchai-p/datasets/tasks || true
          terraform import google_bigquery_dataset.users projects/bai-buchai-p/datasets/users || true
          terraform import google_bigquery_table.creations_profiles projects/bai-buchai-p/datasets/creations/tables/profiles || true
          terraform import google_bigquery_table.tasks_video_generator projects/bai-buchai-p/datasets/tasks/tables/video_generator || true
          terraform import google_bigquery_table.users_auth projects/bai-buchai-p/datasets/users/tables/auth || true
          terraform import google_bigquery_table.users_profiles projects/bai-buchai-p/datasets/users/tables/profiles || true
          terraform import google_storage_bucket.creations bai-buchai-p-stb-usea1-creations || true
          terraform import google_cloud_run_service.server projects/bai-buchai-p/locations/us-east1/services/bai-buchai-p-run-usea1-server || true
          terraform import google_cloud_run_job.video_generator projects/bai-buchai-p/locations/us-east1/jobs/bai-buchai-p-crj-usea1-vidgen || true

      - name: ⚙️ Terraform Plan
        working-directory: ./terraform
        run: terraform plan -out=tfplan

      - name: ⚙️ Terraform Apply
        working-directory: ./terraform
        run: |
          terraform apply -auto-approve tfplan

      - name: 🧹 Cleanup
        if: always()
        run: |
          rm -f service-account.json
          rm -f terraform/terraform.tfvars 