name: Terraform

on:
  push:
    branches:
      - main
    paths:
      - 'terraform/**'
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

jobs:
  terraform:
    environment: google-cloud
    runs-on: ubuntu-latest
    steps:
      - name: âš™ï¸ Checkout repository
        uses: actions/checkout@v2

      - name: âš™ï¸ Authenticate to Google Cloud
        uses: 'google-github-actions/auth@v2'
        with:
          credentials_json: '${{ secrets.GOOGLE_CREDENTIALS }}'

      - name: âš™ï¸ Set up Cloud SDK
        uses: 'google-github-actions/setup-gcloud@v2'
        with:
          project_id: 'bai-buchai-p'

      - name: âš™ï¸ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.7.0"

      - name: âš™ï¸ Create service account key file
        run: |
          echo '${{ secrets.GOOGLE_CREDENTIALS }}' > service-account.json
          chmod 600 service-account.json

      - name: âš™ï¸ Terraform Init
        working-directory: ./terraform
        run: |
          terraform init \
            -backend-config="bucket=bai-buchai-p-tfstate-usea1" \
            -backend-config="prefix=terraform/state"

      - name: âš™ï¸ Terraform Format
        working-directory: ./terraform
        run: terraform fmt -check

      - name: âš™ï¸ Terraform Validate
        working-directory: ./terraform
        run: terraform validate

      - name: âš™ï¸ Import Existing Resources
        working-directory: ./terraform
        run: |
          terraform import google_bigquery_table.creations_profiles bai-buchai-p:creations.profiles || true
          terraform import google_bigquery_table.tasks_video_generator bai-buchai-p:tasks.video_generator || true
          terraform import google_bigquery_table.users_auth bai-buchai-p:users.auth || true
          terraform import google_bigquery_table.users_profiles bai-buchai-p:users.profiles || true

          terraform import google_storage_bucket.creations bai-buchai-p-stb-usea1-creations || true

      - name: âš™ï¸ Terraform Plan
        working-directory: ./terraform
        run: |
          terraform plan \
            -var="gcp_svc_key_file=../service-account.json" \
            -var="gcp_project_id=bai-buchai-p" \
            -var="gcp_region=us-east1" \
            -out=tfplan

      - name: âš™ï¸ Terraform Apply
        working-directory: ./terraform
        run: |
          terraform apply -auto-approve tfplan

      - name: ğŸ§¹ Cleanup
        if: always()
        run: rm -f service-account.json 