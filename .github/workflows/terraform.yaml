name: Terraform

on:
  push:
    branches:
      - main
    paths:
      - 'terraform/**'
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

jobs:
  terraform:
    environment: google-cloud
    runs-on: ubuntu-latest
    steps:
      - name: ‚öôÔ∏è Checkout repository
        uses: actions/checkout@v2

      - name: ‚öôÔ∏è Authenticate to Google Cloud
        uses: 'google-github-actions/auth@v2'
        with:
          credentials_json: '${{ secrets.GOOGLE_CREDENTIALS }}'

      - name: ‚öôÔ∏è Set up Cloud SDK
        uses: 'google-github-actions/setup-gcloud@v2'
        with:
          project_id: 'bai-buchai-p'

      - name: ‚öôÔ∏è Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.7.0"

      - name: ‚öôÔ∏è Create service account key file
        run: |
          echo '${{ secrets.GOOGLE_CREDENTIALS }}' > service-account.json
          chmod 600 service-account.json

      - name: ‚öôÔ∏è Terraform Init
        working-directory: ./terraform
        run: |
          terraform init \
            -backend-config="bucket=bai-buchai-p-tfstate-usea1" \
            -backend-config="prefix=terraform/state"

      - name: ‚öôÔ∏è Terraform Format
        working-directory: ./terraform
        run: terraform fmt -check

      - name: ‚öôÔ∏è Terraform Validate
        working-directory: ./terraform
        run: terraform validate

      - name: ‚öôÔ∏è Import Existing Resources
        working-directory: ./terraform
        run: |
          terraform import \
            -var="gcp_svc_key_file=../service-account.json" \
            -var="gcp_project_id=bai-buchai-p" \
            -var="gcp_region=us-east1" \
            google_bigquery_dataset.creations projects/bai-buchai-p/datasets/creations
          
          terraform import \
            -var="gcp_svc_key_file=../service-account.json" \
            -var="gcp_project_id=bai-buchai-p" \
            -var="gcp_region=us-east1" \
            google_bigquery_dataset.tasks projects/bai-buchai-p/datasets/tasks

          terraform import \
            -var="gcp_svc_key_file=../service-account.json" \
            -var="gcp_project_id=bai-buchai-p" \
            -var="gcp_region=us-east1" \
            google_bigquery_dataset.users projects/bai-buchai-p/datasets/users

          terraform import \
            -var="gcp_svc_key_file=../service-account.json" \
            -var="gcp_project_id=bai-buchai-p" \
            -var="gcp_region=us-east1" \
            google_bigquery_table.creations_profiles projects/bai-buchai-p/datasets/creations/tables/profiles

          terraform import \
            -var="gcp_svc_key_file=../service-account.json" \
            -var="gcp_project_id=bai-buchai-p" \
            -var="gcp_region=us-east1" \
            google_bigquery_table.tasks_video_generator projects/bai-buchai-p/datasets/tasks/tables/video_generator

          terraform import \
            -var="gcp_svc_key_file=../service-account.json" \
            -var="gcp_project_id=bai-buchai-p" \
            -var="gcp_region=us-east1" \
            google_bigquery_table.users_auth projects/bai-buchai-p/datasets/users/tables/auth

          terraform import \
            -var="gcp_svc_key_file=../service-account.json" \
            -var="gcp_project_id=bai-buchai-p" \
            -var="gcp_region=us-east1" \
            google_bigquery_table.users_profiles projects/bai-buchai-p/datasets/users/tables/profiles

          terraform import \
            -var="gcp_svc_key_file=../service-account.json" \
            -var="gcp_project_id=bai-buchai-p" \
            -var="gcp_region=us-east1" \
            google_storage_bucket.creations bai-buchai-p-stb-usea1-creations

      - name: ‚öôÔ∏è Terraform Plan
        working-directory: ./terraform
        run: |
          terraform plan \
            -var="gcp_svc_key_file=../service-account.json" \
            -var="gcp_project_id=bai-buchai-p" \
            -var="gcp_region=us-east1" \
            -out=tfplan

      - name: ‚öôÔ∏è Terraform Apply
        working-directory: ./terraform
        run: |
          terraform apply -auto-approve tfplan

      - name: üßπ Cleanup
        if: always()
        run: rm -f service-account.json 